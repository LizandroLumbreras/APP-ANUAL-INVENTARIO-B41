<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>INVENTARIOS ANUALES PROVEEDORA BODEGA41</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --wm-size: clamp(520px, 72vmin, 1200px);
      --wm-opacity: .14;
      --azul:#00416A; --accent:#0c6cbd; --card:#ffffff;
    }
    *{ box-sizing:border-box; min-width:0 }
    html,body{min-height:100%}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      color:white; padding:clamp(8px,2.3vw,16px); margin:0;
    }

    /* --------- Titular --------- */
    h1.page-title{ text-align:center; margin:6px 0 12px; word-break:break-word }
    /* Ocultar t√≠tulo solo en la pantalla 2 (captura) */
    .view-captura-active h1.page-title{ display:none }

    .fila{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .folio-box{
      background:white; color:#00416A; font-weight:700;
      padding:6px 12px; border-radius:8px; display:inline-block;
      max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    input,button,select{ font-family:inherit; padding:12px; font-size:16px; border-radius:10px; border:none }
    input[type="text"], input[type="number"]{ width:100%; max-width:min(420px, 96vw) }
    .qty{ width:clamp(110px, 22vw, 160px) }
    input[type="number"]{ -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    select{ min-width:clamp(220px, 40vw, 360px); max-width:100% }
    .boton{ background:#0c6cbd; color:white; font-weight:700; cursor:pointer; transition:filter .2s; border-radius:12px }
    .boton:active{ filter:brightness(.9) }
    .btn-ghost{ background:#e8edf6; color:#0c2a5e; font-weight:600; border-radius:12px }
    .sec{ margin-top:12px }
    .chip{ background:white; color:#00416A; border-radius:100px; padding:4px 10px; font-size:12px; font-weight:600; max-width:100%; overflow:hidden; text-overflow:ellipsis }
    .muted{opacity:.9}

    .view{ display:none } .view.active{ display:block }

    /* ---------- Toolbar superior (Pantalla 2) ---------- */
    .toolbar{
      position:sticky; top:0; z-index:40;
      padding: env(safe-area-inset-top) 0 8px;
      margin: 0 0 8px 0;
      background: linear-gradient(180deg, rgba(0,65,106,.80) 0%, rgba(0,65,106,.55) 60%, rgba(0,65,106,0) 100%);
      backdrop-filter: blur(6px);
      border-radius:12px;
    }
    .toolbar .row{
      display:grid; gap:8px; grid-template-columns:repeat(5,minmax(0,1fr));
      align-items:center;
    }
    .toolbar .row button{
      padding:10px 8px; border-radius:12px; font-weight:800; font-size:14px; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* ---------- Tablas ---------- */
    .contenedor-tabla{
      background:var(--card); color:#111; border-radius:12px; overflow:auto;
      margin-top:14px; max-width:100%;
    }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; min-width:560px }
    th,td{ padding:10px; border-bottom:1px solid #e5e7eb; vertical-align:middle; overflow:hidden; text-overflow:ellipsis }
    th{ background-color:#00416A; color:white; position:sticky; top:0; z-index:1; text-align:center }
    td{ text-align:center; word-break:break-word }
    .td-desc{ text-align:left }
    .ellipsis-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    .ellipsis-1{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    /* Controles cantidad en carrito */
    .qtyctrl{ display:flex; gap:8px; align-items:center; justify-content:center; white-space:nowrap }
    .qtyctrl button{ padding:6px 10px; border-radius:8px }

    /* Preview */
    .preview{
      margin-top:10px; background:#ffffffdd; color:#111; border-radius:12px;
      padding:10px; border:2px dashed #0c6cbd; max-width:820px;
    }
    .preview .title{ font-weight:700; color:#0c2a5e }
    .preview .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:6px }
    .preview .pill{
      background:#e8edf6; padding:6px 12px; border-radius:999px; font-weight:600;
      max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .ok{ color:#1e8e3e; font-weight:700 } .warn{ color:#b36b00; font-weight:700 }

    .wm-logo{ position:fixed; inset:0; z-index:0; pointer-events:none }
    .wm-logo img{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:var(--wm-size); opacity:var(--wm-opacity) }

    main{ position:relative; z-index:1; max-width:min(980px, 100%); margin:0 auto }

    /* ====== MOBILE ====== */
    @media (max-width: 640px){
      body{ padding:10px }
      .fila{ gap:8px }
      label{ width:100%; font-size:14px; opacity:.95 }
      input[type="text"], input[type="number"], select{ max-width:none; width:100% }

      /* Tabla -> Cards compactas */
      table{ border:0; min-width:0 } thead{ display:none }
      tbody tr{
        display:block; background:#fff; margin:6px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;
        box-shadow:0 3px 8px rgba(0,0,0,.05);
      }
      tbody td{
        display:flex; justify-content:space-between; align-items:center;
        padding:6px 10px; border-bottom:1px solid #f1f5f9; text-align:left !important; font-size:14px;
      }
      tbody td:first-child{ display:none }
      tbody td::before{
        content: attr(data-label);
        font-weight:700; color:#0c2a5e; margin-right:12px;
      }
      .fecha-cell{ font-size:12px; color:#64748b; justify-content:flex-end; }
      tbody td:last-child{ border-bottom:0 }
    }

    @media print{ .wm-logo{ display:none } .modal{ display:none !important } }

    /* Modal buscador */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:50; padding:10px; display:none }
    .modal .box{ width:min(960px,96vw); max-height:90vh; overflow:auto; background:#f9f9fb; color:#111; border-radius:12px; padding:14px; box-shadow:0 12px 28px rgba(0,0,0,0.3)}
    .modal header{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; position:sticky; top:0; background:#f9f9fb; padding-bottom:6px; z-index:1 }
    .modal input[type="text"]{ border:1px solid #ddd; background:white; color:#111; width:min(560px,86vw) }
    .modal .grid{ display:grid; grid-template-columns:1fr; gap:10px }
    @media (min-width:720px){ .modal .grid{ grid-template-columns:1fr 1fr } }
    .producto-card{ border:2px solid #333; border-radius:10px; padding:10px; background:#fff; box-shadow:2px 2px 6px rgba(0,0,0,0.08) }
    .btn-ok{ background:#1e8e3e; color:white; font-weight:700; border-radius:10px; padding:8px 10px }
   
    /* === Botones de icono (toolbar) === */
    .icon-btn{
      display:grid; place-items:center;
      padding:0;
      width:clamp(44px, 10vw, 56px);
      height:clamp(44px, 10vw, 56px);
      border-radius:14px;
      font-size:clamp(22px, 5.8vw, 28px);
      line-height:1;
    }
    .icon-btn.boton{ background:#0c6cbd; color:#fff }
    .icon-btn.btn-ghost{ background:#e8edf6; color:#0c2a5e }

    .toolbar .row{
      grid-template-columns: repeat(5, minmax(44px, 1fr));
      justify-items:center;
      gap:10px;
    }
  </style>
</head>
<body>
  <div class="wm-logo"><img src="logo_proveedora.webp" alt=""></div>

  <main id="appRoot">
    <h1 class="page-title">INVENTARIOS ANUALES B41<br/>PROVEEDORA</h1>

    <!-- ===== Pantalla 1: Configuraci√≥n ===== -->
    <section id="view-setup" class="view active">
      <div class="fila">
        <div>Folio actual: <span class="folio-box" id="folio"></span></div>
        <span class="chip" id="chipModo">Modo: Acumular</span>
      </div>

      <div class="fila sec">
        <label for="sucursal">Sucursal:</label>
        <select id="sucursal">
          <option value="">-- Selecciona sucursal --</option>
          <option>Bodega 41</option>
        </select>

        <label for="usuario">Usuario:</label>
        <select id="usuario">
          <option value="">-- Selecciona usuario --</option>
          <option>Blanca</option><option>Lizandro</option><option>Edgardo</option><option>Fernanda</option>
          <option>Esmeralda</option><option>Gibran</option><option>Roberto</option><option>Caleb</option><option>Prueba</option>
          <option>Usuario 1</option><option>Usuario 2</option><option>Usuario 3</option><option>Usuario 4</option>
        </select>
      </div>

      <div class="fila sec">
        <button class="boton" id="btnContinuar">‚û° Continuar a captura</button>
      </div>
    </section>

    <!-- ===== Pantalla 2: Captura ===== -->
    <section id="view-captura" class="view">
      <!-- Toolbar superior -->
      <div class="toolbar">
        <div class="row">
          <button class="btn-ghost icon-btn" id="tbBack"   title="Volver"  aria-label="Volver">‚¨ÖÔ∏è</button>
          <button class="btn-ghost icon-btn" id="tbBuscar" title="Buscar"  aria-label="Buscar">üîé</button>
          <button class="btn-ghost icon-btn" id="tbScan"   title="Escanear" aria-label="Escanear">üì∑</button>
          <button class="btn-ghost icon-btn" id="tbCart"   title="Carrito" aria-label="Carrito">üõí</button>
          <button class="boton icon-btn"    id="tbAdd"    title="Agregar" aria-label="Agregar">‚ûï</button>
        </div>
      </div>

      <div class="fila sec">
        <input type="text" id="codigo" placeholder="Escanea o escribe el c√≥digo de barras..." autocomplete="off" inputmode="numeric">
        <input type="number" id="cantidad" class="qty" placeholder="Cantidad" step="0.001" min="0.001" inputmode="decimal">
      </div>

      <!-- Previsualizaci√≥n -->
      <div id="preview" class="preview" style="display:none">
        <div class="title">Previsualizaci√≥n del art√≠culo</div>
        <div class="row">
          <span id="pDesc" class="pill"></span>
          <span id="pCodigo" class="pill"></span>
          <span id="pPeso" class="pill" style="display:none"></span>
        </div>
        <div id="pAviso" style="margin-top:8px" class="muted"></div>
      </div>

      <div id="lector" style="display:none; background:#fff; padding:10px; border-radius:8px; width:min(420px,92vw)"></div>

      <div class="contenedor-tabla">
        <table>
          <thead>
            <tr><th>#</th><th>Descripci√≥n</th><th>C√≥digo</th><th>Cantidad</th><th>Fecha</th></tr>
          </thead>
          <tbody id="tabla-productos"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== Pantalla 3: Carrito ===== -->
    <section id="view-carrito" class="view">
      <div class="fila sec">
        <button class="btn-ghost" id="btnVolverCaptura">‚¨Ö Volver a captura</button>
      </div>
      <div class="contenedor-tabla">
        <table>
          <thead>
            <tr><th>#</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Cantidad</th><th>Hora</th></tr>
          </thead>
          <tbody id="tabla-carrito"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Buscador -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div class="left">
          <strong>üîé Buscador de art√≠culos</strong>
          <input type="text" id="buscador" placeholder="Escribe c√≥digo o nombre...">
        </div>
        <div class="right"><button class="btn-ghost" id="cerrarModal">‚úñ Cerrar</button></div>
      </header>

      <div class="muted" style="padding:6px 2px">
        <progress id="barraProgreso" value="0" max="100" style="width:180px"></progress>
        <span id="estado"></span>
      </div>

      <div id="resultados" class="grid"></div>

      <div class="paginacion">
        <button id="prev" class="btn-ghost" disabled>‚¨Ö Anterior</button>
        <span id="contador" class="muted"></span>
        <button id="next" class="btn-ghost" disabled>Siguiente ‚û°</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center; margin-top:18px; opacity:.9">
    Powered by <b>PROVSOFT</b>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, getDoc, updateDoc,
    query, where, doc, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  /* ========== Firebase (dos proyectos) ========== */
  // LECTURA: bd-bodega41
  const firebaseConfigREAD = {
    apiKey: "AIzaSyA0JYm16CaVXr86ZGbKP8tpe47rl0LdBaw",
    authDomain: "bd-bodega41.firebaseapp.com",
    projectId: "bd-bodega41",
    storageBucket: "bd-bodega41.appspot.com",
    messagingSenderId: "63153834263",
    appId: "1:63153834263:web:32f306d4dea573bee74f52",
    measurementId: "G-YCCWZCHCEV"
  };

  // ESCRITURA: inventariopv-643f1
  const firebaseConfigWRITE = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };

  const appRead  = initializeApp(firebaseConfigREAD,  "app-read-b41");
  const appWrite = initializeApp(firebaseConfigWRITE, "app-write-inv");

  const dbRead  = getFirestore(appRead);   // productos/equivalencias (B41)
  const dbWrite = getFirestore(appWrite);  // escaneos (inventariopv)

  const authWrite = getAuth(appWrite);
  signInAnonymously(authWrite).catch(()=>{});

  /* ========== Utilidades ========== */
  const DEC_CANTIDAD = 3;
  const DELTA = 1;
  const pad2 = (n) => String(n).padStart(2,'0');
  const fechaLocal = (d = new Date()) =>
    `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  const roundTo = (num, dec) => Math.round((Number(num) + Number.EPSILON) * 10**dec) / 10**dec;
  const fmt = (num, dec) => Number(num ?? 0).toFixed(dec);
  const $  = (id) => document.getElementById(id);

  function generarFolio() {
    const d = new Date(), P=n=>String(n).padStart(2,'0');
    const ymd = `${d.getFullYear()}${P(d.getMonth()+1)}${P(d.getDate())}-${P(d.getHours())}${P(d.getMinutes())}${P(d.getSeconds())}`;
    const r = new Uint32Array(1); (self.crypto||window.crypto).getRandomValues(r);
    return `AnualesPDD-${ymd}-${(r[0]>>>0).toString(36).toUpperCase().slice(-5)}`;
  }
  function beep(ms=120, freq=880){
    try{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.2, ctx.currentTime);
      o.start(); setTimeout(()=>{o.stop(); ctx.close();}, ms);
    }catch{}
  }

  /* ========== DOM refs ========== */
  const appRoot=document.getElementById('appRoot');
  const viewSetup=$("view-setup"), viewCaptura=$("view-captura"), viewCarrito=$("view-carrito");
  const folioSpan=$("folio"), chipModo=$("chipModo");
  const selectSucursal=$("sucursal"), selectUsuario=$("usuario"), btnContinuar=$("btnContinuar");
  const inputCodigo=$("codigo"), inputCantidad=$("cantidad");
  const previewBox=$("preview"), pDesc=$("pDesc"), pCodigo=$("pCodigo"), pPeso=$("pPeso"), pAviso=$("pAviso");
  const tabla=$("tabla-productos");
  const tbBack=$("tbBack"), tbBuscar=$("tbBuscar"), tbScan=$("tbScan"), tbCart=$("tbCart"), tbAdd=$("tbAdd");
  const modal=$("modal"), cerrarModalBtn=$("cerrarModal"), inputBuscador=$("buscador"), resultadosDiv=$("resultados");
  const barraProgreso=$("barraProgreso"), estado=$("estado"), contador=$("contador"), btnPrev=$("prev"), btnNext=$("next");
  const divLector=$("lector"), tablaCarrito=$("tabla-carrito"), btnVolverCaptura=$("btnVolverCaptura");

  /* ========== Estado ========== */
  let folio = localStorage.getItem("folioInventarioAnuales") || generarFolio();
  folioSpan.textContent = folio; chipModo.textContent="Modo: Acumular";
  const usuarioPrevio = localStorage.getItem("usuarioInventarioAnuales") || "";
  const sucursalPrev  = localStorage.getItem("sucursalInventarioAnuales") || "";
  if (usuarioPrevio) selectUsuario.value = usuarioPrevio;
  if (sucursalPrev)  selectSucursal.value = sucursalPrev;

  let ultimoRegistro=null, productoPreview=null, cacheProductos=JSON.parse(localStorage.getItem("cacheProductosAnuales")||"{}");
  function persistLocal(){
    localStorage.setItem("folioInventarioAnuales", folio);
    localStorage.setItem("usuarioInventarioAnuales", selectUsuario.value);
    localStorage.setItem("sucursalInventarioAnuales", selectSucursal.value);
  }
  selectUsuario.addEventListener("change", persistLocal);
  selectSucursal.addEventListener("change", persistLocal);

  /* ========== Navegaci√≥n y protecci√≥n refresh ========== */
  function toggleBeforeUnload(enable){
    const handler = (e)=>{ e.preventDefault(); e.returnValue=''; };
    if(enable){ window.addEventListener('beforeunload', handler); }
    else{ window.removeEventListener('beforeunload', handler); }
  }
  function setView(which){
    viewSetup.classList.toggle("active", which==="setup");
    viewCaptura.classList.toggle("active", which==="captura");
    viewCarrito.classList.toggle("active", which==="carrito");
    appRoot.classList.toggle('view-captura-active', which==="captura");
    sessionStorage.setItem('lastView', which);
    toggleBeforeUnload(which==="captura");
  }
  if(sessionStorage.getItem('lastView')==='captura'){ sessionStorage.setItem('lastView','setup'); }

  btnContinuar.addEventListener("click", ()=>{
    if(!selectSucursal.value) return alert("Selecciona una sucursal");
    if(!selectUsuario.value) return alert("Selecciona un usuario");
    persistLocal();
    setView("captura");
    setTimeout(()=>inputCodigo.focus(),100);
  });

  let lector=null;
  async function backToSetup(){
    try{ if(lector){ await lector.stop(); } }catch{}
    lector=null; divLector.style.display="none";
    setView("setup"); window.scrollTo({top:0,behavior:"instant"});
  }
  tbBack.addEventListener("click", backToSetup);
  btnVolverCaptura.addEventListener("click", ()=> setView("captura"));

  /* ========== Productos (LECTURA en B41) ========== */
  function detectarCodigoPeso(codigoStr){
    if(/^\d{13}$/.test(codigoStr) && codigoStr.startsWith("20")){
      const base=codigoStr.substring(0,7);
      const pesoNum=parseInt(codigoStr.substring(7,12),10);
      return {base, pesoKg: pesoNum/1000};
    }
    return null;
  }

  // Equivalencias flexibles: colecci√≥n auxiliar + m√∫ltiples campos
  async function buscarEquivalenteFlexible(code){
    const limpio = String(code).trim();

    // 1) Colecci√≥n auxiliar: equivalencias/{equivalente} -> { principal }
    try{
      const refMap  = doc(dbRead, "equivalencias", limpio);
      const snapMap = await getDoc(refMap);
      if (snapMap.exists() && snapMap.data()?.principal){
        const principalId = String(snapMap.data().principal);
        const pSnap = await getDoc(doc(dbRead,"productos",principalId));
        if (pSnap.exists()){
          return { principal: principalId, data: pSnap.data(), matchedIn: "equivalencias (colecci√≥n)" };
        }
      }
    }catch(_){}

    // 2) Arrays dentro de productos
    for (const campo of ["codigosEquivalentes","equivalentes","codigoEquivalente"]){
      try{
        const qy = query(
          collection(dbRead,"productos"),
          where(campo,"array-contains",limpio),
          limit(1)
        );
        const snap = await getDocs(qy);
        if (!snap.empty){
          const d = snap.docs[0];
          return { principal: d.id, data: d.data(), matchedIn: `${campo} (array)` };
        }
      }catch(_){}
    }

    // 3) Strings dentro de productos
    for (const campo of ["codigoEquivalente","codigoAlterno","codigoSecundario"]){
      try{
        const qy = query(
          collection(dbRead,"productos"),
          where(campo,"==",limpio),
          limit(1)
        );
        const snap = await getDocs(qy);
        if (!snap.empty){
          const d = snap.docs[0];
          return { principal: d.id, data: d.data(), matchedIn: `${campo} (string)` };
        }
      }catch(_){}
    }

    return null;
  }

  // Obtener producto por ID (B41)
  async function getProductoPorId(id){
    const r = doc(dbRead, "productos", id);
    const d = await getDoc(r);
    return d.exists()? {id, ...d.data()} : null;
  }

  // Resolver c√≥digo ‚Üí producto (incluye balanza y equivalencias)
  async function resolverProducto(codigoInput){
    const codigoStr = String(codigoInput).trim();

    // 1) Etiqueta de balanza (20‚Ä¶‚Ä¶)
    const det = detectarCodigoPeso(codigoStr);
    if (det){
      const eq = await buscarEquivalenteFlexible(det.base);
      if (eq && eq.principal){
        const d = eq.data || (await getProductoPorId(eq.principal));
        if (d){
          return {
            descripcion: d.concepto ?? "Sin descripci√≥n",
            codigo: eq.principal,
            cantidad: roundTo(det.pesoKg, DEC_CANTIDAD),
            isPeso: true
          };
        }
      }
    }

    // 2) Cache
    if (cacheProductos?.[codigoStr]) return cacheProductos[codigoStr];

    // 3) C√≥digo de barras exacto
    let s1 = await getDocs(query(
      collection(dbRead,"productos"),
      where("codigoBarra","==",codigoStr),
      limit(1)
    ));
    if (!s1.empty){
      const d = s1.docs[0].data();
      return { descripcion: d.concepto ?? "Sin desc", codigo: s1.docs[0].id };
    }

    // 4) Equivalencias
    const eq = await buscarEquivalenteFlexible(codigoStr);
    if (eq && eq.principal){
      const d = eq.data || (await getProductoPorId(eq.principal));
      if (d) return { descripcion: d.concepto ?? "Sin desc", codigo: eq.principal };
    }

    // 5) Por ID exacto
    const byId = await getProductoPorId(codigoStr);
    if (byId) return { descripcion: byId.concepto ?? "Sin desc", codigo: byId.id };

    throw new Error("Producto no encontrado");
  }

  /* ========== Preview + Guardado (ESCRITURA en inventariopv) ========== */
  async function previsualizar(){
    const codigo=(inputCodigo.value||"").trim();
    if(!codigo){ ocultarPreview(); return; }

    const p=await resolverProducto(codigo);
    productoPreview={ descripcion:p.descripcion, codigo:p.codigo, cantidad:p.cantidad, isPeso:!!p.isPeso };
    pDesc.textContent=p.descripcion || "SIN DESCRIPCI√ìN";
    pCodigo.textContent=`C√≥digo: ${p.codigo}`;
    if(p.isPeso){
      pPeso.style.display="inline-block";
      pPeso.textContent=`Peso detectado: ${fmt(p.cantidad,DEC_CANTIDAD)} kg`;
      inputCantidad.value=fmt(p.cantidad,DEC_CANTIDAD);
      pAviso.innerHTML=`<span class="ok">‚úî C√≥digo de balanza detectado.</span> Ajusta la cantidad y presiona <b>Agregar</b>.`;
    }else{
      pPeso.style.display="none"; inputCantidad.value="";
      pAviso.innerHTML=`<span class="warn">‚åõ Previsualizaci√≥n lista.</span> Captura la cantidad y presiona <b>Agregar</b>.`;
    }
    previewBox.style.display="block";
  }
  function ocultarPreview(){
    previewBox.style.display="none"; pDesc.textContent=""; pCodigo.textContent="";
    pPeso.textContent=""; pPeso.style.display="none"; pAviso.textContent=""; productoPreview=null;
  }

  inputCodigo.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ e.preventDefault(); previsualizar().then(()=> inputCantidad.focus()); }
  });
  inputCodigo.addEventListener("blur", ()=>{ if(inputCodigo.value.trim()) previsualizar(); });

  async function guardarRegistroInmediato(item){
    const registro={
      folioSesion: folio, folioRegistro: generarFolio(), fecha: fechaLocal(), epochMs: Date.now(),
      sucursal: selectSucursal.value, usuario: selectUsuario.value,
      descripcion: item.descripcion, codigo: item.codigo, cantidad: Number(item.cantidad || 0)
    };
    await addDoc(
      collection(dbWrite,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos"),
      registro
    );
    ultimoRegistro=registro; renderTablaUltimo();
  }

  function renderTablaUltimo(){
    tabla.innerHTML="";
    if(!ultimoRegistro) return;
    const p=ultimoRegistro;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td data-label="#">1</td>
      <td data-label="Desc" class="td-desc"><span class="ellipsis-2">${p.descripcion}</span></td>
      <td data-label="Cod" class="ellipsis-1">${p.codigo}</td>
      <td data-label="Cant">${fmt(p.cantidad, DEC_CANTIDAD)}</td>
      <td class="fecha-cell">${p.fecha || ""}</td>
    `;
    tabla.appendChild(tr);
    persistLocal();
  }

  const agregarYGuardar = async ()=>{
    try{
      let p=productoPreview; if(!p){ await previsualizar(); p=productoPreview; }
      if(!p) throw new Error("Primero escanea/escribe un c√≥digo v√°lido");
      let cantidad=roundTo(parseFloat(inputCantidad.value || (p.cantidad ?? "1")), DEC_CANTIDAD);
      if(isNaN(cantidad) || cantidad<=0) throw new Error("Cantidad inv√°lida");

      await guardarRegistroInmediato({ descripcion:p.descripcion, codigo:p.codigo, cantidad });
      inputCodigo.value=""; inputCantidad.value=""; ocultarPreview(); inputCodigo.focus();
    }catch(e){ alert(e.message || "Error al guardar"); }
  };
  let nextFocus = null;

  /* ========== Buscador (LECTURA en B41) ========== */
  function abrirModal(){
    nextFocus = 'codigo';
    inputBuscador.value = "";
    resultados = []; pagina = 0;
    resultadosDiv.innerHTML = ""; contador.textContent = "";
    estado.textContent = ""; barraProgreso.value = 0;
    btnPrev.disabled = true; btnNext.disabled = true;
    modal.style.display = "flex";
    setTimeout(()=> inputBuscador.focus(), 50);
  }
  function cerrarModal(){
    modal.style.display = "none";
    inputBuscador.value = "";
    resultados = []; pagina = 0;
    resultadosDiv.innerHTML = "";
    contador.textContent = "";
    estado.textContent = "";
    barraProgreso.value = 0;
    btnPrev.disabled = true; btnNext.disabled = true;
    inputBuscador.blur();
    setTimeout(()=>{
      if(nextFocus === 'cantidad') inputCantidad?.focus();
      else inputCodigo?.focus();
      nextFocus = null;
    }, 50);
  }
  cerrarModalBtn.addEventListener("click", cerrarModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) cerrarModal(); });
  let resultados=[], pagina=0; const porPagina=20; let debounceTimer;
  inputBuscador.addEventListener("input", ()=>{
    clearTimeout(debounceTimer);
    const t=inputBuscador.value.trim();
    if(!t){ resultadosDiv.innerHTML=""; contador.textContent=""; return; }
    debounceTimer=setTimeout(()=>buscarProductos(t),600);
  });
  btnPrev.addEventListener("click", ()=>mostrarPagina(pagina-1));
  btnNext.addEventListener("click", ()=>mostrarPagina(pagina+1));

  async function buscarProductos(termino){
    resultados=[]; resultadosDiv.innerHTML="‚è≥ Buscando..."; barraProgreso.value=10; estado.textContent="";
    const limpio = termino.trim();

    // Num√©rico: codigoBarra -> equivalencias -> id
    if(/^\d+$/.test(limpio)){
      // codigoBarra exacto
      let snap=await getDocs(query(
        collection(dbRead,"productos"),
        where("codigoBarra","==",limpio),
        limit(1)
      ));
      if(!snap.empty){
        resultados=snap.docs.map(d=>({id:d.id, ...d.data(), coincidencia:"codigoBarra", codigoBuscado:limpio}));
        barraProgreso.value=100; mostrarPagina(0); return;
      }

      // equivalencias flexibles
      const eq = await buscarEquivalenteFlexible(limpio);
      if (eq && eq.principal){
        resultados=[{ id:eq.principal, ...eq.data, coincidencia:eq.matchedIn || "equivalente", codigoBuscado:limpio }];
        barraProgreso.value=100; mostrarPagina(0); return;
      }

      // por id exacto
      const byId = await getProductoPorId(limpio);
      if (byId){
        resultados=[{ id:byId.id, ...byId, coincidencia:"id (documento)", codigoBuscado:limpio }];
        barraProgreso.value=100; mostrarPagina(0); return;
      }

      resultadosDiv.innerHTML="‚ùå No se encontr√≥ este c√≥digo"; contador.textContent=""; barraProgreso.value=100; return;
    }

    // Texto: trae y filtra local (si la colecci√≥n es grande, considerar √≠ndices por prefijo)
    barraProgreso.value=25; estado.textContent="Cargando productos‚Ä¶";
    const snap=await getDocs(collection(dbRead,"productos"));
    const palabras=limpio.toLowerCase().split(/\s+/).filter(Boolean);
    resultados=[];
    snap.forEach(docu=>{
      const p={id:docu.id, ...docu.data()};
      if(p.concepto && palabras.every(w=>String(p.concepto).toLowerCase().includes(w))) resultados.push(p);
    });
    barraProgreso.value=100; estado.textContent="";
    if(!resultados.length){ resultadosDiv.innerHTML="‚ùå Sin resultados"; contador.textContent=""; } else mostrarPagina(0);
  }

  function mostrarPagina(n){
    pagina=n; resultadosDiv.innerHTML="";
    const inicio=pagina*porPagina, fin=inicio+porPagina, lista=resultados.slice(inicio,fin);
    lista.forEach(p=>{
      const div=document.createElement("div"); div.className="producto-card";
      const badgeTxt = p.coincidencia ? `Coincidencia en ${p.coincidencia}` : "";
      const badge = badgeTxt ? `<div style="color:#b00; font-size:12px">üîó ${badgeTxt}${p.codigoBuscado ? ` (${p.codigoBuscado})` : ""}</div>` : "";
      div.innerHTML=`
        <b>${p.concepto || "SIN CONCEPTO"}</b><br>
        C√≥digo: ${p.codigoBarra || p.id}
        ${badge}
        <div style="margin-top:8px"><button class="btn-ok">Usar en previsualizaci√≥n</button></div>
      `;
      div.querySelector(".btn-ok").addEventListener("click", ()=>{
        productoPreview = { descripcion: p.concepto || "Sin desc", codigo: p.id };
        pDesc.textContent = productoPreview.descripcion;
        pCodigo.textContent = `C√≥digo: ${productoPreview.codigo}`;
        pPeso.style.display = "none";
        pAviso.innerHTML = `<span class="warn">‚åõ Previsualizaci√≥n lista.</span> Captura la cantidad y presiona <b>Agregar</b>.`;
        previewBox.style.display = "block";
        inputCantidad.value = "";
        nextFocus = 'cantidad';
        cerrarModal();
      });
      resultadosDiv.appendChild(div);
    });
    contador.textContent=`Resultados: ${resultados.length} | P√°gina ${pagina+1} de ${Math.max(1,Math.ceil(resultados.length/porPagina))}`;
    btnPrev.disabled=pagina===0; btnNext.disabled=fin>=resultados.length;
  }

  /* ========== Esc√°ner (LECTURA) y Carrito (ESCRITURA) ========== */
  async function startStopCam(){
    if(lector){ try{ await lector.stop(); }catch{} lector=null; divLector.style.display="none"; return; }
    divLector.style.display="block"; lector=new Html5Qrcode("lector");
    try{
      const box=Math.floor(Math.min(window.innerWidth*0.8, 320));
      await lector.start(
        { facingMode:"environment" }, { fps:10, qrbox:box },
        async codigo=>{
          try{ await lector.stop(); }catch{} lector=null; divLector.style.display="none";
          inputCodigo.value=codigo;
          try{ await previsualizar(); beep(); inputCantidad.focus(); }
          catch{ abrirModal(); inputBuscador.value=codigo; buscarProductos(codigo); }
        }, err=>{}
      );
    }catch(e){ console.error("Error c√°mara:", e); alert("No se pudo abrir la c√°mara"); }
  }

  async function abrirCarrito(){
    if(!selectSucursal.value || !selectUsuario.value){ alert("Selecciona sucursal y usuario."); return; }
    await cargarCarritoPartidas();
    setView("carrito");
  }

  async function cargarCarritoPartidas(){
    tablaCarrito.innerHTML = "<tr><td colspan='5'>Cargando‚Ä¶</td></tr>";
    const coll = collection(dbWrite,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos");
    const qy = query(coll, where("folioSesion","==", folio));
    const snap = await getDocs(qy);
    const rows = [];
    snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));
    rows.sort((a,b)=> (b.epochMs ?? 0) - (a.epochMs ?? 0));
    if(!rows.length){ tablaCarrito.innerHTML = "<tr><td colspan='5'>Sin partidas en este folio.</td></tr>"; return; }

    tablaCarrito.innerHTML = rows.map((r,i)=>{
      const hora = (r.fecha||"").split(" ")[1] || "";
      return `
        <tr data-id="${r.id}">
          <td data-label="#">${i+1}</td>
          <td data-label="C√≥digo" class="ellipsis-1">${r.codigo||""}</td>
          <td data-label="Descripci√≥n" class="td-desc"><span class="ellipsis-2">${r.descripcion||""}</span></td>
          <td data-label="Cantidad">
            <div class="qtyctrl">
              <button class="btn-ghost" data-action="menos" data-id="${r.id}">‚àí</button>
              <strong>${fmt(r.cantidad, DEC_CANTIDAD)}</strong>
              <button class="btn-ghost" data-action="mas" data-id="${r.id}">+</button>
            </div>
          </td>
          <td data-label="Hora" class="fecha-cell">${hora}</td>
        </tr>
      `;
    }).join("");
  }

  async function modificarCantidad(docId, delta){
    const ref = doc(dbWrite,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos", docId);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    let nueva = roundTo(Number(snap.data().cantidad||0) + delta, DEC_CANTIDAD);
    if(nueva < 0) nueva = 0;
    await updateDoc(ref, { cantidad: nueva, fecha: fechaLocal(), epochMs: Date.now() });
    await cargarCarritoPartidas();
  }

  tablaCarrito.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-action][data-id]");
    if(!btn) return;
    const id = btn.dataset.id;
    const delta = btn.dataset.action === "mas" ? DELTA : -DELTA;
    await modificarCantidad(id, delta);
  });

  /* ========== Toolbar ========== */
  tbAdd.addEventListener("click", agregarYGuardar);
  tbBuscar.addEventListener("click", ()=> abrirModal());
  tbScan.addEventListener("click", startStopCam);
  tbCart.addEventListener("click", abrirCarrito);

  /* ========== Inicia ========== */
  setView("setup");
</script>
</body>
</html>
